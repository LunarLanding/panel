<!DOCTYPE html>

<html lang="en">
<head>
<!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<meta charset="utf-8"/>
<title>jupyter_client.session — Panel 0.10.3 documentation</title>
<meta content="High-level dashboarding for python visualization libraries" name="description"/>
<meta content="Panel contributors" name="author"/>
<!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
    WebFont.load({
      google: {
        families: ['Source Sans Pro']
      }
    });
  </script>
<!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link href="../../_static/css/main.css" rel="stylesheet"/>
<link href="../../_static/nbsite.css" rel="stylesheet"/>
<link href="../../_static/site.css" rel="stylesheet"/>
<!-- Scripts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript">
</script>
<script src="../../_static/js/main.js"></script>
<!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link href="../../_static/favicon.ico" rel="icon" type="image/png"/>
<!-- Canonical
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link href="https://panel.holoviz.org/_modules/jupyter_client/session.html" rel="canonical">
</link></head>
<body class="">
<header class="navigation">
<div class="wrapper">
<a class="logo" href="../../index.html">
<img alt="Logo" src="../../_static/logo_horizontal.png"/>
</a>
<a class="navigation-menu-button" href="javascript:void(0)" id="js-mobile-menu">Menu</a>
<nav>
<ul class="navigation-menu show" id="js-navigation-menu">
<li class="nav-link doc-head"><a href="//discourse.holoviz.org">Discourse</a></li>
<li class="nav-link doc-head"><a href="//twitter.com/Panel_org">Twitter</a></li>
<li class="nav-link doc-head"><a href="//github.com/pyviz/panel">Github</a></li>
<li class="nav-link">
<div style="display:inline-block;vertical-align: middle;">
<div class="search-bar">
<form action="../../search.html" method="get" role="search">
<input name="q" placeholder="Search" type="search"/>
<button type="submit">
<img alt="Search Icon" src="https://raw.githubusercontent.com/thoughtbot/refills/master/source/images/search-icon-black.png"/>
</button>
</form>
</div>
</div>
</li>
</ul>
</nav>
</div>
</header>
<div class="second-nav">
<nav>
<ul class="navigation-menu show">
<li class="nav-link doc-head"><a href="../../getting_started/index.html">Getting started</a></li>
<li class="nav-link doc-head"><a href="../../user_guide/index.html">User Guide</a></li>
<li class="nav-link doc-head"><a href="../../gallery/index.html">Gallery</a></li>
<li class="nav-link doc-head"><a href="../../reference/index.html">Reference Gallery</a></li>
<li class="nav-link doc-head"><a href="../../developer_guide/index.html">Developer Guide</a></li>
<li class="nav-link doc-head"><a href="../../releases.html">Releases</a></li>
<li class="nav-link doc-head"><a href="../../api/index.html">API</a></li>
<li class="nav-link doc-head"><a href="../../FAQ.html">FAQ</a></li>
<li class="nav-link doc-head"><a href="../../about.html">About</a></li>
</ul>
</nav>
</div>
<!-- MAIN BODY OF DOCS –––––––––––––––––– -->
<div class="docs section">
<div id="hacketyhackhack"> <!-- style="width:20%;margin-right: 100px;"> --> <!--style="display: none;"> style="display:none;"> -->
<div class="toc" style="width:15%; margin-right:20px;">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gallery/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Comparisons.html">Comparisons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Roadmap.html">Road Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pyviz/panel">Github source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>
</div>
</div>
<div class="content"> <!-- style="max-width:80%;margin-left:auto;margin-right: auto;">-->
<h1>Source code for jupyter_client.session</h1><div class="highlight"><pre>
<span></span><span class="sd">"""Session object for building, serializing, sending, and receiving messages.</span>

<span class="sd">The Session object supports serialization, HMAC signatures,</span>
<span class="sd">and metadata on messages.</span>

<span class="sd">Also defined here are utilities for working with Sessions:</span>
<span class="sd">* A SessionFactory to be used as a base class for configurables that work with</span>
<span class="sd">Sessions.</span>
<span class="sd">* A Message object for convenience that allows attribute-access to the msg dict.</span>
<span class="sd">"""</span>

<span class="c1"># Copyright (c) Jupyter Development Team.</span>
<span class="c1"># Distributed under the terms of the Modified BSD License.</span>

<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">b2a_hex</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">PICKLE_PROTOCOL</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">DEFAULT_PROTOCOL</span>

<span class="c1"># We are using compare_digest to limit the surface of timing attacks</span>
<span class="kn">from</span> <span class="nn">hmac</span> <span class="kn">import</span> <span class="n">compare_digest</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="n">utc</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>

<span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">from</span> <span class="nn">zmq.utils</span> <span class="kn">import</span> <span class="n">jsonapi</span>
<span class="kn">from</span> <span class="nn">zmq.eventloop.ioloop</span> <span class="kn">import</span> <span class="n">IOLoop</span>
<span class="kn">from</span> <span class="nn">zmq.eventloop.zmqstream</span> <span class="kn">import</span> <span class="n">ZMQStream</span>

<span class="kn">from</span> <span class="nn">traitlets.config.configurable</span> <span class="kn">import</span> <span class="n">Configurable</span><span class="p">,</span> <span class="n">LoggingConfigurable</span>
<span class="kn">from</span> <span class="nn">ipython_genutils.importstring</span> <span class="kn">import</span> <span class="n">import_item</span>
<span class="kn">from</span> <span class="nn">jupyter_client.jsonutil</span> <span class="kn">import</span> <span class="n">extract_dates</span><span class="p">,</span> <span class="n">squash_dates</span><span class="p">,</span> <span class="n">date_default</span>
<span class="kn">from</span> <span class="nn">ipython_genutils.py3compat</span> <span class="kn">import</span> <span class="n">str_to_bytes</span><span class="p">,</span> <span class="n">str_to_unicode</span>
<span class="kn">from</span> <span class="nn">traitlets</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CBytes</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Instance</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">DottedObjectName</span><span class="p">,</span> <span class="n">CUnicode</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">TraitError</span><span class="p">,</span> <span class="n">observe</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">jupyter_client</span> <span class="kn">import</span> <span class="n">protocol_version</span>
<span class="kn">from</span> <span class="nn">jupyter_client.adapter</span> <span class="kn">import</span> <span class="n">adapt</span>
<span class="kn">from</span> <span class="nn">traitlets.log</span> <span class="kn">import</span> <span class="n">get_logger</span>


<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># utility functions</span>
<span class="c1">#-----------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">squash_unicode</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">"""coerce unicode back to bytestrings."""</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">squash_unicode</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">obj</span><span class="p">[</span><span class="n">squash_unicode</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">squash_unicode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf8'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># globals and defaults</span>
<span class="c1">#-----------------------------------------------------------------------------</span>

<span class="c1"># default values for the thresholds:</span>
<span class="n">MAX_ITEMS</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">MAX_BYTES</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="c1"># ISO8601-ify datetime objects</span>
<span class="c1"># allow unicode</span>
<span class="c1"># disallow nan, because it's not actually valid JSON</span>
<span class="n">json_packer</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">jsonapi</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">date_default</span><span class="p">,</span>
    <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">json_unpacker</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">jsonapi</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="n">pickle_packer</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">squash_dates</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">PICKLE_PROTOCOL</span><span class="p">)</span>
<span class="n">pickle_unpacker</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span>

<span class="n">default_packer</span> <span class="o">=</span> <span class="n">json_packer</span>
<span class="n">default_unpacker</span> <span class="o">=</span> <span class="n">json_unpacker</span>

<span class="n">DELIM</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">"&lt;IDS|MSG&gt;"</span>
<span class="c1"># singleton dummy tracker, which will always report as done</span>
<span class="n">DONE</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">MessageTracker</span><span class="p">()</span>

<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># Mixin tools for apps that use Sessions</span>
<span class="c1">#-----------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">new_id</span><span class="p">():</span>
    <span class="sd">"""Generate a new random id.</span>

<span class="sd">    Avoids problematic runtime import in stdlib uuid on Python 2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    id string (16 random bytes as hex-encoded text, chunks separated by '-')</span>
<span class="sd">    """</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'-'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="n">buf</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
    <span class="p">))</span>

<span class="k">def</span> <span class="nf">new_id_bytes</span><span class="p">():</span>
    <span class="sd">"""Return new_id as ascii bytes"""</span>
    <span class="k">return</span> <span class="n">new_id</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">)</span>

<span class="n">session_aliases</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">ident</span> <span class="o">=</span> <span class="s1">'Session.session'</span><span class="p">,</span>
    <span class="n">user</span> <span class="o">=</span> <span class="s1">'Session.username'</span><span class="p">,</span>
    <span class="n">keyfile</span> <span class="o">=</span> <span class="s1">'Session.keyfile'</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">session_flags</span>  <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'secure'</span> <span class="p">:</span> <span class="p">({</span><span class="s1">'Session'</span> <span class="p">:</span> <span class="p">{</span> <span class="s1">'key'</span> <span class="p">:</span> <span class="n">new_id_bytes</span><span class="p">(),</span>
                            <span class="s1">'keyfile'</span> <span class="p">:</span> <span class="s1">''</span> <span class="p">}},</span>
        <span class="sd">"""Use HMAC digests for authentication of messages.</span>
<span class="sd">        Setting this flag will generate a new UUID to use as the HMAC key.</span>
<span class="sd">        """</span><span class="p">),</span>
    <span class="s1">'no-secure'</span> <span class="p">:</span> <span class="p">({</span><span class="s1">'Session'</span> <span class="p">:</span> <span class="p">{</span> <span class="s1">'key'</span> <span class="p">:</span> <span class="sa">b</span><span class="s1">''</span><span class="p">,</span> <span class="s1">'keyfile'</span> <span class="p">:</span> <span class="s1">''</span> <span class="p">}},</span>
        <span class="sd">"""Don't authenticate messages."""</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">default_secure</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
    <span class="sd">"""Set the default behavior for a config environment to be secure.</span>

<span class="sd">    If Session.key/keyfile have not been set, set Session.key to</span>
<span class="sd">    a new random UUID.</span>
<span class="sd">    """</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"default_secure is deprecated"</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'Session'</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">'key'</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">Session</span> <span class="ow">or</span> <span class="s1">'keyfile'</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">Session</span><span class="p">:</span>
            <span class="k">return</span>
    <span class="c1"># key/keyfile not specified, generate new UUID:</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">new_id_bytes</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">utcnow</span><span class="p">():</span>
    <span class="sd">"""Return timezone-aware UTC timestamp"""</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">utc</span><span class="p">)</span>

<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># Classes</span>
<span class="c1">#-----------------------------------------------------------------------------</span>

<span class="k">class</span> <span class="nc">SessionFactory</span><span class="p">(</span><span class="n">LoggingConfigurable</span><span class="p">):</span>
    <span class="sd">"""The Base class for configurables that have a Session, Context, logger,</span>
<span class="sd">    and IOLoop.</span>
<span class="sd">    """</span>

    <span class="n">logname</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s1">'logname'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_logname_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">change</span><span class="p">[</span><span class="s1">'new'</span><span class="p">])</span>

    <span class="c1"># not configurable:</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">'zmq.Context'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_context_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">'jupyter_client.session.Session'</span><span class="p">,</span>
                       <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">loop</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">'tornado.ioloop.IOLoop'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_loop_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># construct the session</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Message</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""A simple message object that maps dict keys to attributes.</span>

<span class="sd">    A Message can be created from a dict and a dict from a Message instance</span>
<span class="sd">    simply by calling dict(msg_obj)."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_dict</span><span class="p">):</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">dct</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># Having this iterator lets dict(msg_obj) work out of the box.</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">msg_header</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
    <span class="sd">"""Create a new message header"""</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">utcnow</span><span class="p">()</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">protocol_version</span>
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">extract_header</span><span class="p">(</span><span class="n">msg_or_header</span><span class="p">):</span>
    <span class="sd">"""Given a message or header, return the header."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_or_header</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># See if msg_or_header is the entire message.</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">msg_or_header</span><span class="p">[</span><span class="s1">'header'</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># See if msg_or_header is just the header</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">msg_or_header</span><span class="p">[</span><span class="s1">'msg_id'</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">msg_or_header</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span>

<span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="n">Configurable</span><span class="p">):</span>
    <span class="sd">"""Object for handling serialization and sending of messages.</span>

<span class="sd">    The Session object handles building messages and sending them</span>
<span class="sd">    with ZMQ sockets or ZMQStream objects.  Objects can communicate with each</span>
<span class="sd">    other over the network via Session objects, and only need to work with the</span>
<span class="sd">    dict-based IPython message spec. The Session will handle</span>
<span class="sd">    serialization/deserialization, security, and metadata.</span>

<span class="sd">    Sessions support configurable serialization via packer/unpacker traits,</span>
<span class="sd">    and signing with HMAC digests via the key/keyfile traits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    debug : bool</span>
<span class="sd">        whether to trigger extra debugging statements</span>
<span class="sd">    packer/unpacker : str : 'json', 'pickle' or import_string</span>
<span class="sd">        importstrings for methods to serialize message parts.  If just</span>
<span class="sd">        'json' or 'pickle', predefined JSON and pickle packers will be used.</span>
<span class="sd">        Otherwise, the entire importstring must be used.</span>

<span class="sd">        The functions must accept at least valid JSON input, and output *bytes*.</span>

<span class="sd">        For example, to use msgpack:</span>
<span class="sd">        packer = 'msgpack.packb', unpacker='msgpack.unpackb'</span>
<span class="sd">    pack/unpack : callables</span>
<span class="sd">        You can also set the pack/unpack callables for serialization directly.</span>
<span class="sd">    session : bytes</span>
<span class="sd">        the ID of this Session object.  The default is to generate a new UUID.</span>
<span class="sd">    username : unicode</span>
<span class="sd">        username added to message headers.  The default is to ask the OS.</span>
<span class="sd">    key : bytes</span>
<span class="sd">        The key used to initialize an HMAC signature.  If unset, messages</span>
<span class="sd">        will not be signed or checked.</span>
<span class="sd">    keyfile : filepath</span>
<span class="sd">        The file containing a key.  If this is set, `key` will be initialized</span>
<span class="sd">        to the contents of the file.</span>

<span class="sd">    """</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"""Debug output in the Session"""</span><span class="p">)</span>

    <span class="n">check_pid</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"""Whether to check PID to protect against calls after fork.</span>

<span class="s2">        This check can be disabled if fork-safety is handled elsewhere.</span>
<span class="s2">        """</span><span class="p">)</span>

    <span class="n">packer</span> <span class="o">=</span> <span class="n">DottedObjectName</span><span class="p">(</span><span class="s1">'json'</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">"""The name of the packer for serializing messages.</span>
<span class="s2">            Should be one of 'json', 'pickle', or an import name</span>
<span class="s2">            for a custom callable serializer."""</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s1">'packer'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_packer_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">'new'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'json'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pack</span> <span class="o">=</span> <span class="n">json_packer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span> <span class="o">=</span> <span class="n">json_unpacker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unpacker</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">elif</span> <span class="n">new</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'pickle'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pack</span> <span class="o">=</span> <span class="n">pickle_packer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span> <span class="o">=</span> <span class="n">pickle_unpacker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unpacker</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pack</span> <span class="o">=</span> <span class="n">import_item</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new</span><span class="p">))</span>

    <span class="n">unpacker</span> <span class="o">=</span> <span class="n">DottedObjectName</span><span class="p">(</span><span class="s1">'json'</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"""The name of the unpacker for unserializing messages.</span>
<span class="s2">        Only used with custom functions for `packer`."""</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s1">'unpacker'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_unpacker_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">'new'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'json'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pack</span> <span class="o">=</span> <span class="n">json_packer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span> <span class="o">=</span> <span class="n">json_unpacker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packer</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">elif</span> <span class="n">new</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'pickle'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pack</span> <span class="o">=</span> <span class="n">pickle_packer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span> <span class="o">=</span> <span class="n">pickle_unpacker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packer</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span> <span class="o">=</span> <span class="n">import_item</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new</span><span class="p">))</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">CUnicode</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"""The UUID identifying this session."""</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_session_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">new_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsession</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s1">'session'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_session_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsession</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">)</span>

    <span class="c1"># bsession is the session as bytes</span>
    <span class="n">bsession</span> <span class="o">=</span> <span class="n">CBytes</span><span class="p">(</span><span class="sa">b</span><span class="s1">''</span><span class="p">)</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">str_to_unicode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'USER'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">)),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"""Username for the Session. Default is your system username."""</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">({},</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"""Metadata dictionary, which serves as the default top-level metadata dict for each message."""</span><span class="p">)</span>

    <span class="c1"># if 0, no adapting to do.</span>
    <span class="n">adapt_version</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># message signature related traits:</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">CBytes</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"""execution key, for signing messages."""</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_key_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">new_id_bytes</span><span class="p">()</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s1">'key'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_key_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_auth</span><span class="p">()</span>

    <span class="n">signature_scheme</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s1">'hmac-sha256'</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"""The digest scheme used to construct the message signatures.</span>
<span class="s2">        Must have the form 'hmac-HASH'."""</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s1">'signature_scheme'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_signature_scheme_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">'new'</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'hmac-'</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s2">"signature_scheme must start with 'hmac-', got </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">new</span><span class="p">)</span>
        <span class="n">hash_name</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digest_mod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hashlib</span><span class="p">,</span> <span class="n">hash_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s2">"hashlib has no such attribute: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span>
                             <span class="n">hash_name</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_auth</span><span class="p">()</span>

    <span class="n">digest_mod</span> <span class="o">=</span> <span class="n">Any</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_digest_mod_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span>

    <span class="n">auth</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_new_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">digestmod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">digest_mod</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">digest_history</span> <span class="o">=</span> <span class="n">Set</span><span class="p">()</span>
    <span class="n">digest_history_size</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"""The maximum number of digests to remember.</span>

<span class="s2">        The digest history will be culled when it exceeds this value.</span>
<span class="s2">        """</span>
    <span class="p">)</span>

    <span class="n">keyfile</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"""path to file containing execution key."""</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s1">'keyfile'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_keyfile_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">change</span><span class="p">[</span><span class="s1">'new'</span><span class="p">],</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># for protecting against sends from forks</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">()</span>

    <span class="c1"># serialization traits:</span>

    <span class="n">pack</span> <span class="o">=</span> <span class="n">Any</span><span class="p">(</span><span class="n">default_packer</span><span class="p">)</span> <span class="c1"># the actual packer function</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s1">'pack'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_pack_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">'new'</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">new</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"packer must be callable, not </span><span class="si">%s</span><span class="s2">"</span><span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">new</span><span class="p">))</span>

    <span class="n">unpack</span> <span class="o">=</span> <span class="n">Any</span><span class="p">(</span><span class="n">default_unpacker</span><span class="p">)</span> <span class="c1"># the actual packer function</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s1">'unpack'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_unpack_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="c1"># unpacker is not checked - it is assumed to be</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">'new'</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">new</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"unpacker must be callable, not </span><span class="si">%s</span><span class="s2">"</span><span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">new</span><span class="p">))</span>

    <span class="c1"># thresholds:</span>
    <span class="n">copy_threshold</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"Threshold (in bytes) beyond which a buffer should be sent without copying."</span><span class="p">)</span>
    <span class="n">buffer_threshold</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">MAX_BYTES</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"Threshold (in bytes) beyond which an object's buffer should be extracted to avoid pickling."</span><span class="p">)</span>
    <span class="n">item_threshold</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">MAX_ITEMS</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"""The maximum number of items for a container to be introspected for custom serialization.</span>
<span class="s2">        Containers larger than this are pickled outright.</span>
<span class="s2">        """</span>
    <span class="p">)</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""create a Session object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        debug : bool</span>
<span class="sd">            whether to trigger extra debugging statements</span>
<span class="sd">        packer/unpacker : str : 'json', 'pickle' or import_string</span>
<span class="sd">            importstrings for methods to serialize message parts.  If just</span>
<span class="sd">            'json' or 'pickle', predefined JSON and pickle packers will be used.</span>
<span class="sd">            Otherwise, the entire importstring must be used.</span>

<span class="sd">            The functions must accept at least valid JSON input, and output</span>
<span class="sd">            *bytes*.</span>

<span class="sd">            For example, to use msgpack:</span>
<span class="sd">            packer = 'msgpack.packb', unpacker='msgpack.unpackb'</span>
<span class="sd">        pack/unpack : callables</span>
<span class="sd">            You can also set the pack/unpack callables for serialization</span>
<span class="sd">            directly.</span>
<span class="sd">        session : unicode (must be ascii)</span>
<span class="sd">            the ID of this Session object.  The default is to generate a new</span>
<span class="sd">            UUID.</span>
<span class="sd">        bsession : bytes</span>
<span class="sd">            The session as bytes</span>
<span class="sd">        username : unicode</span>
<span class="sd">            username added to message headers.  The default is to ask the OS.</span>
<span class="sd">        key : bytes</span>
<span class="sd">            The key used to initialize an HMAC signature.  If unset, messages</span>
<span class="sd">            will not be signed or checked.</span>
<span class="sd">        signature_scheme : str</span>
<span class="sd">            The message digest scheme. Currently must be of the form 'hmac-HASH',</span>
<span class="sd">            where 'HASH' is a hashing function available in Python's hashlib.</span>
<span class="sd">            The default is 'hmac-sha256'.</span>
<span class="sd">            This is ignored if 'key' is empty.</span>
<span class="sd">        keyfile : filepath</span>
<span class="sd">            The file containing a key.  If this is set, `key` will be</span>
<span class="sd">            initialized to the contents of the file.</span>
<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_packers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">none</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">({})</span>
        <span class="c1"># ensure self._session_default() if necessary, so bsession is defined:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_auth</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Message signing is disabled.  This is insecure and not recommended!"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Create a copy of this Session</span>

<span class="sd">        Useful when connecting multiple times to a given kernel.</span>
<span class="sd">        This prevents a shared digest_history warning about duplicate digests</span>
<span class="sd">        due to multiple connections to IOPub in the same process.</span>

<span class="sd">        .. versionadded:: 5.1</span>
<span class="sd">        """</span>
        <span class="c1"># make a copy</span>
        <span class="n">new_session</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traits</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">new_session</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="c1"># fork digest_history</span>
        <span class="n">new_session</span><span class="o">.</span><span class="n">digest_history</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">new_session</span><span class="o">.</span><span class="n">digest_history</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digest_history</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_session</span>

    <span class="n">message_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">msg_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">message_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">message_number</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_packers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""check packers for datetime support."""</span>
        <span class="n">pack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack</span>
        <span class="n">unpack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span>

        <span class="c1"># check simple serialization</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="s1">'hi'</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"packer '</span><span class="si">{packer}</span><span class="s2">' could not serialize a simple message: </span><span class="si">{e}{jsonmsg}</span><span class="s2">"</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packer</span> <span class="o">==</span> <span class="s1">'json'</span><span class="p">:</span>
                <span class="n">jsonmsg</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">zmq.utils.jsonapi.jsonmod = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">jsonapi</span><span class="o">.</span><span class="n">jsonmod</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jsonmsg</span> <span class="o">=</span> <span class="s2">""</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">packer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">jsonmsg</span><span class="o">=</span><span class="n">jsonmsg</span><span class="p">)</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># ensure packed message is bytes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">packed</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"message packed to </span><span class="si">%r</span><span class="s2">, but bytes are required"</span><span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">packed</span><span class="p">))</span>

        <span class="c1"># check that unpack is pack's inverse</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">unpacked</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">packed</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">unpacked</span> <span class="o">==</span> <span class="n">msg</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"unpacker '</span><span class="si">{unpacker}</span><span class="s2">' could not handle output from packer '</span><span class="si">{packer}</span><span class="s2">': </span><span class="si">{e}{jsonmsg}</span><span class="s2">"</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packer</span> <span class="o">==</span> <span class="s1">'json'</span><span class="p">:</span>
                <span class="n">jsonmsg</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">zmq.utils.jsonapi.jsonmod = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">jsonapi</span><span class="o">.</span><span class="n">jsonmod</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jsonmsg</span> <span class="o">=</span> <span class="s2">""</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">packer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="p">,</span> <span class="n">unpacker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unpacker</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">jsonmsg</span><span class="o">=</span><span class="n">jsonmsg</span><span class="p">)</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># check datetime support</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">unpacked</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unpacked</span><span class="p">[</span><span class="s1">'t'</span><span class="p">],</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Shouldn't deserialize to datetime"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pack</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">pack</span><span class="p">(</span><span class="n">squash_dates</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">unpack</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">msg_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">msg_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg_id</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Return the nested message dict.</span>

<span class="sd">        This format is different from what is sent over the wire. The</span>
<span class="sd">        serialize/deserialize methods converts this nested message dict to the wire</span>
<span class="sd">        format, which is a list of message parts.</span>
<span class="sd">        """</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_header</span><span class="p">(</span><span class="n">msg_type</span><span class="p">)</span> <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">header</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">'header'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">'msg_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'msg_id'</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">'msg_type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'msg_type'</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">'parent_header'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">extract_header</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">content</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">'metadata'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">'metadata'</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_list</span><span class="p">):</span>
        <span class="sd">"""Sign a message with HMAC digest. If no auth, return b''.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg_list : list</span>
<span class="sd">            The [p_header,p_parent,p_content] part of the message list.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s1">''</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msg_list</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">str_to_bytes</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">ident</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Serialize the message components to bytes.</span>

<span class="sd">        This is roughly the inverse of deserialize. The serialize/deserialize</span>
<span class="sd">        methods work with full message lists, whereas pack/unpack work with</span>
<span class="sd">        the individual message parts in the message list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg : dict or Message</span>
<span class="sd">            The next message dict as returned by the self.msg method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        msg_list : list</span>
<span class="sd">            The list of bytes objects to be sent with the format::</span>

<span class="sd">                [ident1, ident2, ..., DELIM, HMAC, p_header, p_parent,</span>
<span class="sd">                 p_metadata, p_content, buffer1, buffer2, ...]</span>

<span class="sd">            In this list, the ``p_*`` entities are the packed or serialized</span>
<span class="sd">            versions, so if JSON is used, these are utf8 encoded JSON strings.</span>
<span class="sd">        """</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'content'</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">none</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="c1"># content is already packed, as in a relayed message</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># should be bytes, but JSON often spits out unicode</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf8'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Content incorrect type: </span><span class="si">%s</span><span class="s2">"</span><span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

        <span class="n">real_message</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">'header'</span><span class="p">]),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">'parent_header'</span><span class="p">]),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">'metadata'</span><span class="p">]),</span>
                        <span class="n">content</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">to_send</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># accept list of idents</span>
            <span class="n">to_send</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ident</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">to_send</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
        <span class="n">to_send</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>

        <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">real_message</span><span class="p">)</span>
        <span class="n">to_send</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>

        <span class="n">to_send</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">real_message</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">to_send</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">msg_or_type</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ident</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">buffers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">track</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Build and send a message via stream or socket.</span>

<span class="sd">        The message format used by this function internally is as follows:</span>

<span class="sd">        [ident1,ident2,...,DELIM,HMAC,p_header,p_parent,p_content,</span>
<span class="sd">         buffer1,buffer2,...]</span>

<span class="sd">        The serialize/deserialize methods convert the nested message dict into this</span>
<span class="sd">        format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        stream : zmq.Socket or ZMQStream</span>
<span class="sd">            The socket-like object used to send the data.</span>
<span class="sd">        msg_or_type : str or Message/dict</span>
<span class="sd">            Normally, msg_or_type will be a msg_type unless a message is being</span>
<span class="sd">            sent more than once. If a header is supplied, this can be set to</span>
<span class="sd">            None and the msg_type will be pulled from the header.</span>

<span class="sd">        content : dict or None</span>
<span class="sd">            The content of the message (ignored if msg_or_type is a message).</span>
<span class="sd">        header : dict or None</span>
<span class="sd">            The header dict for the message (ignored if msg_to_type is a message).</span>
<span class="sd">        parent : Message or dict or None</span>
<span class="sd">            The parent or parent header describing the parent of this message</span>
<span class="sd">            (ignored if msg_or_type is a message).</span>
<span class="sd">        ident : bytes or list of bytes</span>
<span class="sd">            The zmq.IDENTITY routing path.</span>
<span class="sd">        metadata : dict or None</span>
<span class="sd">            The metadata describing the message</span>
<span class="sd">        buffers : list or None</span>
<span class="sd">            The already-serialized buffers to be appended to the message.</span>
<span class="sd">        track : bool</span>
<span class="sd">            Whether to track.  Only for use with Sockets, because ZMQStream</span>
<span class="sd">            objects cannot track messages.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        msg : dict</span>
<span class="sd">            The constructed message.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">):</span>
            <span class="c1"># ZMQStreams and dummy sockets do not support tracking.</span>
            <span class="n">track</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg_or_type</span><span class="p">,</span> <span class="p">(</span><span class="n">Message</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="c1"># We got a Message or message dict, not a msg_type so don't</span>
            <span class="c1"># build a new Message.</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg_or_type</span>
            <span class="n">buffers</span> <span class="o">=</span> <span class="n">buffers</span> <span class="ow">or</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'buffers'</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">msg_or_type</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
                           <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_pid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"WARNING: attempted to send message from fork</span><span class="se">\n</span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
                <span class="n">msg</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">buffers</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">buffers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">buffers</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">buf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buffers</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">):</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">buf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># check to see if buf supports the buffer protocol.</span>
                    <span class="n">view</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Buffer objects must support the buffer protocol."</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="c1"># memoryview.contiguous is new in 3.3,</span>
            <span class="c1"># just skip the check on Python 2</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">'contiguous'</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">view</span><span class="o">.</span><span class="n">contiguous</span><span class="p">:</span>
                <span class="c1"># zmq requires memoryviews to be contiguous</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Buffer </span><span class="si">%i</span><span class="s2"> (</span><span class="si">%r</span><span class="s2">) is not contiguous"</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt_version</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">adapt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt_version</span><span class="p">)</span>
        <span class="n">to_send</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ident</span><span class="p">)</span>
        <span class="n">to_send</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>
        <span class="n">longest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">to_send</span> <span class="p">])</span>
        <span class="n">copy</span> <span class="o">=</span> <span class="p">(</span><span class="n">longest</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_threshold</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">buffers</span> <span class="ow">and</span> <span class="n">track</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">copy</span><span class="p">:</span>
            <span class="c1"># only really track when we are doing zero-copy buffers</span>
            <span class="n">tracker</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">(</span><span class="n">to_send</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">track</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use dummy tracker, which will be done immediately</span>
            <span class="n">tracker</span> <span class="o">=</span> <span class="n">DONE</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">(</span><span class="n">to_send</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">to_send</span><span class="p">)</span>
            <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>

        <span class="n">msg</span><span class="p">[</span><span class="s1">'tracker'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracker</span>

        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">send_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">msg_list</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ident</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Send a raw message via ident path.</span>

<span class="sd">        This method is used to send a already serialized message.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stream : ZMQStream or Socket</span>
<span class="sd">            The ZMQ stream or socket to use for sending the message.</span>
<span class="sd">        msg_list : list</span>
<span class="sd">            The serialized list of messages to send. This only includes the</span>
<span class="sd">            [p_header,p_parent,p_metadata,p_content,buffer1,buffer2,...] portion of</span>
<span class="sd">            the message.</span>
<span class="sd">        ident : ident or list</span>
<span class="sd">            A single ident or a list of idents to use in sending.</span>
<span class="sd">        """</span>
        <span class="n">to_send</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="p">[</span><span class="n">ident</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ident</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">to_send</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>

        <span class="n">to_send</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>
        <span class="c1"># Don't include buffers in signature (per spec).</span>
        <span class="n">to_send</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">msg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]))</span>
        <span class="n">to_send</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">msg_list</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">(</span><span class="n">to_send</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">zmq</span><span class="o">.</span><span class="n">NOBLOCK</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">"""Receive and unpack a message.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        socket : ZMQStream or Socket</span>
<span class="sd">            The socket or stream to use in receiving.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        [idents], msg</span>
<span class="sd">            [idents] is a list of idents and msg is a nested message dict of</span>
<span class="sd">            same format as self.msg returns.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">ZMQStream</span><span class="p">):</span>
            <span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg_list</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ZMQError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">:</span>
                <span class="c1"># We can convert EAGAIN to None as we know in this case</span>
                <span class="c1"># recv_multipart won't return None.</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="c1"># split multipart message into identity list and message dict</span>
        <span class="c1"># invalid large messages can cause very expensive string comparisons</span>
        <span class="n">idents</span><span class="p">,</span> <span class="n">msg_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_identities</span><span class="p">(</span><span class="n">msg_list</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idents</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">msg_list</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># TODO: handle it</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">feed_identities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_list</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">"""Split the identities from the rest of the message.</span>

<span class="sd">        Feed until DELIM is reached, then return the prefix as idents and</span>
<span class="sd">        remainder as msg_list. This is easily broken by setting an IDENT to DELIM,</span>
<span class="sd">        but that would be silly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg_list : a list of Message or bytes objects</span>
<span class="sd">            The message to be split.</span>
<span class="sd">        copy : bool</span>
<span class="sd">            flag determining whether the arguments are bytes or Messages</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (idents, msg_list) : two lists</span>
<span class="sd">            idents will always be a list of bytes, each of which is a ZMQ</span>
<span class="sd">            identity. msg_list will be a list of bytes or zmq.Messages of the</span>
<span class="sd">            form [HMAC,p_header,p_parent,p_content,buffer1,buffer2,...] and</span>
<span class="sd">            should be unpackable/unserializable via self.deserialize at this</span>
<span class="sd">            point.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">msg_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg_list</span><span class="p">[:</span><span class="n">idx</span><span class="p">],</span> <span class="n">msg_list</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">msg_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bytes</span> <span class="o">==</span> <span class="n">DELIM</span><span class="p">:</span>
                    <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">failed</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"DELIM not in msg_list"</span><span class="p">)</span>
            <span class="n">idents</span><span class="p">,</span> <span class="n">msg_list</span> <span class="o">=</span> <span class="n">msg_list</span><span class="p">[:</span><span class="n">idx</span><span class="p">],</span> <span class="n">msg_list</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">bytes</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">idents</span><span class="p">],</span> <span class="n">msg_list</span>

    <span class="k">def</span> <span class="nf">_add_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signature</span><span class="p">):</span>
        <span class="sd">"""add a digest to history to protect against replay attacks"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digest_history_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no history, never add digests</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">digest_history</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digest_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">digest_history_size</span><span class="p">:</span>
            <span class="c1"># threshold reached, cull 10%</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cull_digest_history</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cull_digest_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""cull the digest history</span>

<span class="sd">        Removes a randomly selected 10% of the digest history</span>
<span class="sd">        """</span>
        <span class="n">current</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digest_history</span><span class="p">)</span>
        <span class="n">n_to_cull</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">current</span> <span class="o">//</span> <span class="mi">10</span><span class="p">),</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digest_history_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_to_cull</span> <span class="o">&gt;=</span> <span class="n">current</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digest_history</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">to_cull</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digest_history</span><span class="p">,</span> <span class="n">n_to_cull</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">digest_history</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">to_cull</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_list</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">"""Unserialize a msg_list to a nested message dict.</span>

<span class="sd">        This is roughly the inverse of serialize. The serialize/deserialize</span>
<span class="sd">        methods work with full message lists, whereas pack/unpack work with</span>
<span class="sd">        the individual message parts in the message list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg_list : list of bytes or Message objects</span>
<span class="sd">            The list of message parts of the form [HMAC,p_header,p_parent,</span>
<span class="sd">            p_metadata,p_content,buffer1,buffer2,...].</span>
<span class="sd">        content : bool (True)</span>
<span class="sd">            Whether to unpack the content dict (True), or leave it packed</span>
<span class="sd">            (False).</span>
<span class="sd">        copy : bool (True)</span>
<span class="sd">            Whether msg_list contains bytes (True) or the non-copying Message</span>
<span class="sd">            objects in each place (False).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        msg : dict</span>
<span class="sd">            The nested message dict with top-level keys [header, parent_header,</span>
<span class="sd">            content, buffers].  The buffers are returned as memoryviews.</span>
<span class="sd">        """</span>
        <span class="n">minlen</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">copy</span><span class="p">:</span>
            <span class="c1"># pyzmq didn't copy the first parts of the message, so we'll do it</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minlen</span><span class="p">):</span>
                <span class="n">msg_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bytes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">msg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">signature</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unsigned Message"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">digest_history</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Duplicate Signature: </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">signature</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
                <span class="c1"># Only store signature if we are unpacking content, don't store if just peeking.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_digest</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>
            <span class="n">check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">msg_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">compare_digest</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">check</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid Signature: </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">signature</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">minlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"malformed message, must have at least </span><span class="si">%i</span><span class="s2"> elements"</span><span class="o">%</span><span class="n">minlen</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">msg_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">'header'</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_dates</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">'msg_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'msg_id'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">'msg_type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'msg_type'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">'parent_header'</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_dates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">msg_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">'metadata'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">msg_list</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">message</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">msg_list</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg_list</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">buffers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">memoryview</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">msg_list</span><span class="p">[</span><span class="mi">5</span><span class="p">:]]</span>
        <span class="k">if</span> <span class="n">buffers</span> <span class="ow">and</span> <span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># force copy to workaround pyzmq #646</span>
            <span class="n">buffers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">memoryview</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">msg_list</span><span class="p">[</span><span class="mi">5</span><span class="p">:]]</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">'buffers'</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="c1"># adapt to the current version</span>
        <span class="k">return</span> <span class="n">adapt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">"Session.unserialize is deprecated. Use Session.deserialize."</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_msg2obj</span><span class="p">():</span>
    <span class="n">am</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ao</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">am</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ao</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">am</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span>

    <span class="n">am</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ao</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">am</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ao</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="n">am</span><span class="p">[</span><span class="s1">'y'</span><span class="p">][</span><span class="s1">'z'</span><span class="p">]</span>

    <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'z'</span>
    <span class="k">assert</span> <span class="n">ao</span><span class="p">[</span><span class="n">k1</span><span class="p">][</span><span class="n">k2</span><span class="p">]</span> <span class="o">==</span> <span class="n">am</span><span class="p">[</span><span class="n">k1</span><span class="p">][</span><span class="n">k2</span><span class="p">]</span>

    <span class="n">am2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ao</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">am</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="o">==</span> <span class="n">am2</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">am</span><span class="p">[</span><span class="s1">'y'</span><span class="p">][</span><span class="s1">'z'</span><span class="p">]</span> <span class="o">==</span> <span class="n">am2</span><span class="p">[</span><span class="s1">'y'</span><span class="p">][</span><span class="s1">'z'</span><span class="p">]</span>
</pre></div>
</div>
</div>
<!-- END MAIN BODY OF DOCS ––––––––––––– -->
<!-- Google Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-154795830-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154795830-2', { 'anonymize_ip': true });
</script>
<!-- MathJax Config -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>